name: Build-Scan-Push Docker Image (Auto Version)

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # Needed to commit the updated VERSION file
    
    env:
      IMAGE_NAME: ivolve-project
      AWS_REGION: us-east-1  # Change if different
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: List repository contents
        run: ls -la
#   Reads current version from VERSION file
#   Version format must be: v[number] (e.g., v1)
#   If VERSION file is missing, the workflow will fail at this step        
      - name: Read version
        id: version
        run: |
          VERSION=$(cat VERSION)
          echo "current=$VERSION" >> $GITHUB_OUTPUT
          echo "Version is: $VERSION"
#   Increments version by 1 (v5 ‚Üí v6)      
      - name: Increment version
        id: bump
        run: |
          CURRENT=${{ steps.version.outputs.current }}
          NUM=${CURRENT#v}
          NEXT=$((NUM + 1))
          NEW="v$NEXT"
          echo "$NEW" > VERSION
          echo "next=$NEW" >> $GITHUB_OUTPUT
          echo "Next version will be: $NEW"
#   Commits new version back to repository      
      - name: Commit updated VERSION
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add VERSION
          git commit -m "Auto bump version to ${{ steps.bump.outputs.next }}"
          git push
# Update the image name and tag in the deploymnet.yaml
# print the file content to make sure it's updated
      - name: Update Kubernetes manifests
        run: |
          echo "üìù Updating Kubernetes manifests with new image version..."
          sed -i "s|image: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.IMAGE_NAME }}:.*|image: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.current }}|g" kubernets_manifests/deployment.yaml
          echo "‚úÖ Updated deployment.yaml"
          cat kubernets_manifests/deployment.yaml | grep "image:"
      
      - name: Commit updated Kubernetes manifests
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add kubernets_manifests/deployment.yaml
          git commit -m "Update Kubernetes deployment to version ${{ steps.version.outputs.current }}"
          git push
# Create secrets in github to use it to use with AWS              
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
#   Builds Docker image with version tag + 'latest' tag      
      - name: Build docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          docker build -f app/Dockerfile -t $ECR_REGISTRY/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.current }} \
                 -t $ECR_REGISTRY/${{ env.IMAGE_NAME }}:latest app/
          echo "‚úÖ Built image: $ECR_REGISTRY/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.current }}"
      
      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@0.33.1
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        with:
          image-ref: ${{ env.ECR_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.current }}
          format: table
          ignore-unfixed: true
#   Pushes both tags to Docker Hub          
      - name: Push image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          docker push $ECR_REGISTRY/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.current }}
          docker push $ECR_REGISTRY/${{ env.IMAGE_NAME }}:latest
          echo "‚úÖ Pushed to ECR: $ECR_REGISTRY/${{ env.IMAGE_NAME }}"
#   Cleans up local images      
      - name: Delete local images
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          docker rmi $ECR_REGISTRY/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.current }} || true
          docker rmi $ECR_REGISTRY/${{ env.IMAGE_NAME }}:latest || true
          echo "‚úÖ Cleaned up local images"
# Notify on pipeline success using telegram bot
#easy and fun to setup.
      - name: Notify Telegram on success
        if: success()
        run: |
         curl -s -X POST https://api.telegram.org/bot8387769801:AAE5j1gGOZAqJIOtkYEqp17i40z07QiZpSo/sendMessage \
         -d chat_id=207481062 \
         -d text="üéâ GitHub Action succeeded! Version: ${{ steps.version.outputs.current }}"
